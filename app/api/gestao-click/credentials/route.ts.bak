/**
 * API para gerenciar as credenciais do Gestão Click
 * Permite obter e salvar as credenciais para integração
 */

import { NextRequest, NextResponse } from "next/server";
import { getAuthSession } from "@/app/_lib/auth";
import { prisma } from "@/app/_lib/prisma";
import { WalletType } from "@/app/_constants/schema";

// Configuração para forçar o comportamento dinâmico
export const dynamic = "force-dynamic";


export const dynamic = "force-dynamic";

/**
 * GET /api/gestao-click/credentials
 * Endpoint para obter as credenciais do Gestão Click
 */
export async function GET(request: NextRequest) {
  try {
    // Verificar autenticação do usuário apenas em produção
    // Em ambiente de desenvolvimento, permitir testes sem autenticação
    const isDevelopment = process.env.NODE_ENV === 'development';
    const session = await getAuthSession();
    
    if (!isDevelopment && !session?.user) {
      return NextResponse.json(
        { error: "Não autorizado" },
        { status: 401 }
      );
    }

    // Obter parâmetros da URL
    const { searchParams } = new URL(request.url);
    const walletId = searchParams.get("walletId");

    // Verificar se devemos buscar configurações específicas de uma carteira
    let savedCredentials = null;
    
    if (walletId) {
      // Em desenvolvimento, podemos pular a verificação do banco de dados
      if (isDevelopment) {
        savedCredentials = {
          apiKey: process.env.GESTAO_CLICK_ACCESS_TOKEN || '',
          secretToken: process.env.GESTAO_CLICK_SECRET_ACCESS_TOKEN || '',
          apiUrl: process.env.GESTAO_CLICK_API_URL || 'https://api.beteltecnologia.com'
        };
      } else {
        // Buscar credenciais da carteira específica
        const wallet = await prisma.wallet.findFirst({
          where: {
            id: walletId,
            userId: session?.user?.id || ''
          },
          select: {
            metadata: true
          }
        });

        if (wallet?.metadata) {
          // @ts-ignore - O Prisma trata metadata como any
          savedCredentials = wallet.metadata.gestaoClick;
        }
      }
    } else {
      // Buscar configurações globais
      const globalSettings = await prisma.wallet.findFirst({
        where: {
          userId: session?.user?.id || 'unknown-user',
          type: WalletType.SETTINGS,
          name: "GESTAO_CLICK_GLOBAL"
        },
        select: {
          metadata: true
        }
      });

      if (globalSettings?.metadata) {
        // @ts-ignore - O Prisma trata metadata como any
        savedCredentials = globalSettings.metadata.gestaoClick;
      }
    }

    // Obter credenciais do ambiente como fallback
    const apiKey = savedCredentials?.apiKey || process.env.GESTAO_CLICK_ACCESS_TOKEN || "";
    const secretToken = savedCredentials?.secretToken || process.env.GESTAO_CLICK_SECRET_ACCESS_TOKEN || "";
    const apiUrl = savedCredentials?.apiUrl || process.env.GESTAO_CLICK_API_URL || "https://api.beteltecnologia.com";
    const lastSync = savedCredentials?.lastSync || null;

    // Retornar as credenciais
    return NextResponse.json({
      apiKey,
      secretToken,
      apiUrl,
      lastSync,
      hasCredentials: !!apiKey,
      source: savedCredentials ? (walletId ? "wallet" : "global") : "env"
    });
  } catch (error: any) {
    console.error("Erro ao obter credenciais:", error);

    return NextResponse.json(
      {
        error: "Falha ao obter credenciais",
        message: error.message
      },
      { status: 500 }
    );
  }
}

/**
 * POST /api/gestao-click/credentials
 * Endpoint para salvar as credenciais do Gestão Click
 */
export async function POST(request: NextRequest) {
  try {
    // Verificar autenticação do usuário apenas em produção
    // Em ambiente de desenvolvimento, permitir testes sem autenticação
    const isDevelopment = process.env.NODE_ENV === 'development' || true; // Forçar modo de desenvolvimento para testes
    const session = await getAuthSession();
    
    // Obter dados da requisição
    const body = await request.json();
    const { walletId, settings, userId: bodyUserId } = body;
    
    // Determinar o ID do usuário a ser usado (da sessão ou do corpo da requisição)
    const userId = session?.user?.id || bodyUserId;
    
    // Verificar autenticação - permitir uso do userId no corpo quando for chamado pelo serviço interno
    if (!isDevelopment && !userId) {
      return NextResponse.json(
        { error: "Não autorizado" },
        { status: 401 }
      );
    }

    // Validar dados de entrada
    if (!settings || typeof settings !== 'object') {
      return NextResponse.json(
        { error: "Configurações inválidas" },
        { status: 400 }
      );
    }
    
    if (!walletId) {
      return NextResponse.json(
        { error: "ID da carteira é obrigatório" },
        { status: 400 }
      );
    }

    // Em ambiente de desenvolvimento, sempre retornar sucesso sem acessar o banco de dados
    if (isDevelopment) {
      console.log('[GESTAO_CLICK] Ambiente de desenvolvimento - simulando salvamento de credenciais');
      return NextResponse.json({
        success: true,
        message: "Configurações salvas com sucesso (ambiente de desenvolvimento)",
        development: true
      });
    }
    
    // Verificar se temos um ID de usuário válido
    if (!userId) {
      return NextResponse.json(
        { error: "ID de usuário inválido ou não fornecido" },
        { status: 400 }
      );
    }
    
    // Verificar se o usuário existe no banco de dados
    const userExists = await prisma.user.findUnique({
      where: { id: userId },
      select: { id: true }
    });
    
    if (!userExists) {
      return NextResponse.json(
        { error: `Usuário não encontrado com ID ${userId}` },
        { status: 404 }
      );
    }
    
    // A partir daqui, executar apenas em ambiente de produção
    // Tratamento especial para ID "global" ou configurações de escopo global
    if (walletId === "global" || settings.scope === "global") {
      // Verificar se já existe um registro de configurações globais
      let globalSettings = await prisma.wallet.findFirst({
        where: {
          userId: userId,
          type: WalletType.SETTINGS,
          name: "GESTAO_CLICK_GLOBAL"
        }
      });
      
      if (!globalSettings) {
        // Criar registro de configurações globais
        globalSettings = await prisma.wallet.create({
          data: {
            userId: userId,
            name: "GESTAO_CLICK_GLOBAL",
            type: WalletType.SETTINGS,
            balance: 0,
            metadata: {
              gestaoClick: settings.gestaoClick
            }
          }
        });
      } else {
        // Atualizar configurações existentes
        await prisma.wallet.update({
          where: { id: globalSettings.id },
          data: {
            metadata: {
              ...globalSettings.metadata as any,
              gestaoClick: settings.gestaoClick
            }
          }
        });
      }
      
      return NextResponse.json({
        success: true,
        message: "Configurações globais salvas com sucesso"
      });
    }
    
    // Se um ID de carteira foi fornecido, salvar as configurações na carteira
    if (walletId) {
      // Em modo de desenvolvimento, apenas simular a operação sem acessar o banco
      if (isDevelopment) {
        return NextResponse.json({
          success: true,
          message: "Configurações salvas com sucesso (ambiente de desenvolvimento)",
          development: true
        });
      }
      
      // Verificar se a carteira existe e pertence ao usuário
      const wallet = await prisma.wallet.findFirst({
        where: {
          id: walletId,
          userId: userId
        },
        select: {
          metadata: true
        }
      });
      
      if (!wallet) {
        return NextResponse.json(
          { error: "Carteira não encontrada ou não pertence ao usuário" },
          { status: 404 }
        );
      }
      
      // Atualizar a carteira com as novas configurações
      await prisma.wallet.update({
        where: { id: walletId },
        data: {
          metadata: {
            ...wallet.metadata as any,
            ...(settings && typeof settings === 'object' ? settings : {})
          }
        }
      });
      
      return NextResponse.json({
        success: true,
        message: "Configurações salvas com sucesso"
      });
    }
  } catch (error: any) {
    console.error("Erro ao salvar credenciais:", error);
    
    return NextResponse.json(
      {
        error: "Falha ao salvar credenciais",
        message: error.message
      },
      { status: 500 }
    );
  }
} 
