# Configuração Docker Swarm para ContaRapida
# Nota: A partir do Docker Compose v2, o atributo 'version' não é mais necessário

services:
  # Aplicação principal ContaRapida
  contarapida:
    image: dashboard_personalprime:latest
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-sua_chave_secreta_forte}
      - DOMAIN=${DOMAIN:-dashboard.lojapersonalprime.com}
      - RESEND_API_KEY=${RESEND_API_KEY:-re_dummy_key}
      - GROQ_API_KEY=${GROQ_API_KEY:-gsk_dummy_key}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk_dummy_key}
      - GESTAO_CLICK_ACCESS_TOKEN=${GESTAO_CLICK_ACCESS_TOKEN:-dummy_token}
      - GESTAO_CLICK_SECRET_ACCESS_TOKEN=${GESTAO_CLICK_SECRET_ACCESS_TOKEN:-dummy_secret}
    volumes:
      - dashboard_logs:/app/logs
      - dashboard_uploads:/app/public/uploads
    command: sh -c "if [ ! -d '.next/server' ]; then echo 'Build não encontrado, executando build...' && npx next build; fi && npm start"
    networks:
      - AcceleraNet
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
      labels:
        - traefik.enable=true
        - traefik.http.routers.dashboard_personal.rule=Host(`${DOMAIN}`)
        - traefik.http.routers.dashboard_personal.entrypoints=websecure
        - traefik.http.routers.dashboard_personal.tls.certresolver=letsencryptresolver
        - traefik.http.services.dashboard_personal.loadbalancer.server.port=3000
        - traefik.http.services.dashboard_personal.loadbalancer.passHostHeader=true
        - traefik.http.routers.dashboard_personal.service=dashboard_personal
        - traefik.docker.network=AcceleraNet

networks:
  AcceleraNet:
    external: true

volumes:
  dashboard_logs:
  dashboard_uploads: 