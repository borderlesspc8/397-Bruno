name: "Revisão de Pull Request"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  code-review:
    name: Revisão de Código
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: contarapida_test
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Verificar cache de dependências
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: |
            **/node_modules
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Instalar dependências
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci
      
      - name: Gerar cliente Prisma
        run: npx prisma generate
      
      - name: Verificar tipos TypeScript
        run: npm run typecheck
      
      - name: Executar linting
        run: npm run lint
      
      - name: Identificar arquivos alterados
        id: files
        uses: jitterbit/get-changed-files@v1
      
      - name: Executar testes unitários
        run: npm run test:unit -- --coverage
      
      - name: Executar testes de integração
        run: npm run test:integration -- --coverage
      
      - name: Publicar relatório de cobertura
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests,integrationtests
          fail_ci_if_error: false
  
  comment-pr:
    name: Comentar no PR
    needs: [code-review]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Resumo de análise
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const codeReviewStatus = "${{ needs.code-review.result }}";
            
            const statusEmoji = (status) => {
              if (status === 'success') return '✅';
              if (status === 'failure') return '❌';
              return '⚠️';
            };
            
            const comment = `## Resumo da Revisão Automática
            
            ### Verificações
            
            ${statusEmoji(codeReviewStatus)} **Revisão de Código**: ${codeReviewStatus === 'success' ? 'Aprovado' : 'Problemas encontrados'}
            
            ${codeReviewStatus === 'success' 
              ? '✨ **Tudo parece estar em ordem!** Este PR está pronto para revisão humana.'
              : '⚠️ **Alguns problemas foram encontrados.** Por favor, verifique os detalhes acima e corrija os problemas antes de solicitar revisão.'}
            
            ---
            _Este comentário foi gerado automaticamente pelo workflow de CI/CD._`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 